
## Support for mathematical formulas


### Requirements

Use the suggested TEI notation: `<formula id=f1 notation="TeX">$$E = mc^2$$</formula>` (see [TEI guidelines](http://www.tei-c.org/release/doc/tei-p5-doc/en/html/FT.html#FTFOR))

* Meet Project Gutenberg rules, that is convert to HTML and ePub without any dynamic content (that is, no javascript, no external fonts or dependencies on non-standard software, etc.)
* Look as good as normal (dynamic) MathJax output.
* Fully automated processing on command line (that is, it can be integrated in a build process)


### Implementation

The Project Gutenberg prohibition on active content make the direct use of MathJax impossible, so we need to follow a more complicated way to include mathematical formulas in text intended for PG.

The process consists of three steps:

1. Run `tei2html` to let XSLT export all formulas into separate `.tex` files in a directory `formulas`. This is done during normal processing.
2. Run the perl script `convertFormulas.pl` to convert all these files to SVG files (and MathML).
3. Run `tei2html` again (if needed with the `-f` option) to include the generated SVG files as images (or inline) in the resulting file, and use metrics from the SVG files to generate proper CSS.

The resulting output files are placed in a folder `formulas`, and named according to the following naming scheme `(inline|display)-<ID>.tex`. The name is important, as the conversion script uses that to determine the correct MathJax option to use when converting the file to SVG, etc.

The script `convertFormulas.pl` will convert these files to files named `(inline|display)-<ID>.svg`. This script will use node.js with mathjax-node-cli to produce HTML, SVG, and MathML files from the exported formulas.


### Configuration

The following configuration options are available:

* `math.mathJax.format` determines the way mathJax is used to generate math. Possible values:
  * `MathJax`: use MathJax dynamically (loading javascript libraries)
  * `MML`: use inline MathML notation (generated by mathjax-node-cli)
  * `SVG`: use inline SVG (generated by mathjax-node-cli)
  * `SVG+IMG`: use SVG files, included using an HTML `img` tag.
* `math.mathJax.configuration` determines the MathJax configuration to use (only when the `MathJax` format is used).
* `math.label.position` determines the place where equation numbers are placed (valid values: `left` and `right`).
* `math.label.before` string to be placed before the equation number (default a left parenthesis).
* `math.label.after` string to be place dafter the equation number (default a right parenthesis).

### Installation of tools

1. install [Node.js](https://nodejs.org/en/). Make sure to install both node.js and npm.
2. install [Mathjax-node](https://github.com/mathjax/mathjax-node) using `npm install -g mathjax-node`.
3. install [Mathjax-node-cli](https://github.com/mathjax/mathjax-node-cli) using `npm install -g mathjax-node-cli`.

### Implementation details

#### Baseline correction

The baseline is stored in the SVG files generated by MathJax. They can be read from the SVG file, using Xpath `/svg/@style`, and then parsing for the CSS value `vertical-align`. Similarly, the width and height can be retrieved from `/svg/@width` and `/svg/@height/`, and need to be set in CSS. All this CSS should apply to the `<img>` tag, to make sure that the SVG image is rendered at the correct size and on the proper baseline.

The spoken version is also encoded in the MathJax generated SVG file, using Xpath, `/svg/title`, and needs to be extracted, and set in the `@title` attribute of the image (or a surrounding span) to be visible as a pop-up.

Some articles about finding the baseline (that didn't contain the obvious solution that the information is available in the SVG file itself):

1. https://tex.stackexchange.com/questions/44486/pixel-perfect-vertical-alignment-of-image-rendered-tex-snippets/45621
2. https://www.princexml.com/forum/topic/2971/using-mathjax-with-princexml

#### Deduplication

Often, the same formula appears multiple times in the same document. It makes sense to only generate a single SVG file for each formula, and include it multiple times.

#### Trivial math

Very often, a single letter or digit is (correctly) marked as an equation. To avoid needless use of MathJax, we can simply render those trivial expressions directly in HTML, and thus for some texts reduce the number of invocations of MathJax dramatically. Be aware that in this case, the appearance of letters in such trivial equations may differ from those in more complex equations, due to differences in font rendering and the way SVG is handled by browsers.

#### Labeled equations

Numbered equations have a label (between parentheses) set flush-right. Here we use the label encoded on `@n` attribute, format it, and place it flush right. The configuration setting ``math.label.position`` (with possible values ``left`` and ``right``) can be used to determine whether the label should go to the left or right edge of the text. (note that to maintain centering, a label will be generated on both sides of the display formula in any case, and either the right or the left will be made invisible.)

Since we cannot have further mark-up in the values of attributes, we use a 'light' markup syntax to use italics and bold on labels. To get 1*a*, type ``1_a_``; to get 2**b**, type ``2__b__``. Parenthesis can be supplied, based on the setting ``math.label.before`` and ``math.label.after``.

### Open Issues

1. _Unexpected Line breaks._ Currently, we see linebreaks directly after the HTML ``<span>``, even when punctuation marks directly follow the math. We will probably have to wrap the entire formula and the following punctuation in a no-wrap ``<span>`` to prevent this. A simple work-around is to put the final punctuation inside the equation.
2. _Punctuation after labeled display math._ Some books place punctuation after the label to end a sentence or phrase. With the current implementation, this is very tricky to emulate. Placing the punctuation after the formula is the most logical from a semantic point of view, but will require a lot of effort. As a work-around place this punctuation within the displayed equation.
3. _No line-breaks._ Since HTML is unable to break SVG into lines, math formulas will not be broken into lines. You may consider breaking very long formulas into multiple fragments as a measure of last resort.

